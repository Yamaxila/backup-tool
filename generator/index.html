<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±—ç–∫–∞–ø–∞</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 20px auto; padding: 0 15px; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input, select { width: 100%; padding: 6px; margin-top: 4px; box-sizing: border-box; }
        button { margin-top: 8px; padding: 6px 12px; cursor: pointer; }
        .section { border: 1px solid #ccc; padding: 15px; margin-top: 20px; border-radius: 6px; }
        .item { background: #f9f9f9; padding: 12px; margin-top: 12px; border-radius: 5px; position: relative; }
        .item h4 { margin: 0 0 8px 0; }
        .remove-btn { position: absolute; top: 8px; right: 8px; }
        pre { background: #eee; padding: 12px; overflow-x: auto; white-space: pre-wrap; border-radius: 4px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
<h1>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±—ç–∫–∞–ø–∞</h1>

<label>–õ–æ–∫–∞–ª—å–Ω—ã–π –ø—É—Ç—å –¥–ª—è –±—ç–∫–∞–ø–æ–≤:
    <input type="text" id="localBackupPath" value="/backups" />
</label>

<!-- Database Users -->
<div class="section">
    <h3>–£—á—ë—Ç–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –¥–ª—è –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö</h3>
    <div id="dbUsersContainer"></div>
    <button type="button" onclick="addDBUser()">+ –î–æ–±–∞–≤–∏—Ç—å —É—á—ë—Ç–Ω—É—é –∑–∞–ø–∏—Å—å</button>
</div>

<!-- –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ -->
<div class="section">
    <h3>–î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏</h3>
    <div id="dirsContainer"></div>
    <button type="button" onclick="addDir()">+ –î–æ–±–∞–≤–∏—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é</button>
</div>

<!-- –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö -->
<div class="section">
    <h3>–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h3>
    <div id="dbsContainer"></div>
    <button type="button" onclick="addDB()">+ –î–æ–±–∞–≤–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö</button>
</div>

<!-- SMB Upload -->
<div class="section">
    <h3>–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ SMB</h3>
    <label>
        –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å:
        <select id="uploadActive">
            <option value="true">–î–∞</option>
            <option value="false" selected>–ù–µ—Ç</option>
        </select>
    </label>
    <label>SMB Host: <input type="text" id="smbHost" placeholder="192.168.1.234" /></label>
    <label>SMB User: <input type="text" id="smbUser" placeholder="domain\\user" /></label>
    <label>SMB Password: <input type="password" id="smbPassword" /></label>
    <label>SMB Share: <input type="text" id="smbShare" placeholder="\\\\server\\share" /></label>
</div>

<button onclick="generateConfig()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å JSON</button>
<pre id="output"></pre>

<script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    addDBUser();
    addDir();
    addDB();

    function addDBUser() {
        const container = document.getElementById('dbUsersContainer');
        const div = document.createElement('div');
        div.className = 'item';
        const key = 'user_' + Date.now();
        div.innerHTML = `
        <label>–ò–º—è —Å—Å—ã–ª–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, prod_pg): <input type="text" value="${key}" /></label>
        <div class="grid">
          <label>–•–æ—Å—Ç: <input type="text" value="localhost" /></label>
          <label>–ü–æ—Ä—Ç: <input type="number" class="port-input" value="5432" /></label>
        </div>
        <label>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <input type="text" placeholder="backup_user" /></label>
        <label>–ü–∞—Ä–æ–ª—å: <input type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></label>
        <button type="button" class="remove-btn" onclick="this.parentElement.remove()">‚úï</button>
      `;
        container.appendChild(div);
    }

    function addDir() {
        const container = document.getElementById('dirsContainer');
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
        <label>–ü—É—Ç—å: <input type="text" placeholder="/path/to/dir" /></label>
        <label>Lifetime (–¥–Ω–µ–π): <input type="number" value="7" min="1" /></label>
        <button type="button" class="remove-btn" onclick="this.parentElement.remove()">‚úï</button>
      `;
        container.appendChild(div);
    }

    function addDB() {
        const container = document.getElementById('dbsContainer');
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
        <label>–ò–º—è –ë–î: <input type="text" placeholder="mydb" /></label>
        <label>–¢–∏–ø:
          <select>
            <option>postgres</option>
            <option>mysql</option>
            <option>mongo</option>
          </select>
        </label>
        <label>–£—á—ë—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å:
          <select class="user-ref-select">
            <!-- –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
          </select>
        </label>
        <label>Lifetime (–¥–Ω–µ–π): <input type="number" value="30" min="1" /></label>
        <button type="button" class="remove-btn" onclick="this.parentElement.remove()">‚úï</button>
      `;
        container.appendChild(div);
        updateDBUserSelect(div.querySelector('.user-ref-select'));
    }

    function updateDBUserSelect(select) {
        // –û—á–∏—Å—Ç–∏—Ç—å
        select.innerHTML = '';
        // –ó–∞–ø–æ–ª–Ω–∏—Ç—å –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —É—á—ë—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
        document.querySelectorAll('#dbUsersContainer .item').forEach(item => {
            const keyInput = item.querySelector('input[type="text"]');
            const key = keyInput.value.trim();
            if (key) {
                const opt = document.createElement('option');
                opt.value = key;
                opt.textContent = key;
                select.appendChild(opt);
            }
        });
    }

    // –û–±–Ω–æ–≤–ª—è—Ç—å –≤—Å–µ –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—á—ë—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
    document.getElementById('dbUsersContainer').addEventListener('input', function(e) {
        if (e.target.tagName === 'INPUT' && e.target.type === 'text') {
            document.querySelectorAll('#dbsContainer .user-ref-select').forEach(sel => {
                updateDBUserSelect(sel);
            });
        }
    });

    document.getElementById('dbUsersContainer').addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-btn')) {
            setTimeout(() => {
                document.querySelectorAll('#dbsContainer .user-ref-select').forEach(sel => {
                    updateDBUserSelect(sel);
                });
            }, 10);
        }
    });

    function generateConfig() {
        const config = {
            localBackupPath: document.getElementById('localBackupPath').value.trim() || "/backups",
            databaseUsers: {},
            dirs: [],
            files: [],
            databases: [],
            upload: {
                active: document.getElementById('uploadActive').value === 'true',
                smbuser: document.getElementById('smbUser').value,
                smbpassword: document.getElementById('smbPassword').value,
                smbhost: document.getElementById('smbHost').value,
                smbshare: document.getElementById('smbShare').value,
            }
        };

        // –°–±–æ—Ä databaseUsers
        document.querySelectorAll('#dbUsersContainer .item').forEach(item => {
            const inputs = item.querySelectorAll('input');
            const key = inputs[0].value.trim();
            if (!key) return;
            const host = inputs[1].value.trim() || "localhost";
            const port = parseInt(inputs[2].value) || 5432;
            const user = inputs[3].value.trim();
            const password = inputs[4].value;
            config.databaseUsers[key] = { host, port, user, password };
        });

        // –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        document.querySelectorAll('#dirsContainer .item').forEach(item => {
            const path = item.querySelectorAll('input')[0].value.trim();
            const lifetime = parseInt(item.querySelectorAll('input')[1].value) || 7;
            if (path) config.dirs.push({ path, lifetime });
        });

        // –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        document.querySelectorAll('#dbsContainer .item').forEach(item => {
            const name = item.querySelectorAll('input')[0].value.trim();
            const type = item.querySelector('select').value;
            const userRef = item.querySelector('.user-ref-select').value;
            const lifetime = parseInt(item.querySelectorAll('input')[1].value) || 30;
            if (name && userRef) {
                config.databases.push({ name, type, userRef, lifetime });
            }
        });

        const jsonStr = JSON.stringify(config, null, 2);
        const output = document.getElementById('output');
        output.textContent = jsonStr;

        // –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        const existingLink = output.querySelector('a');
        if (existingLink) existingLink.remove();

        const blob = new Blob([jsonStr], { type: 'application/json;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'backup-config.json';
        a.textContent = 'üì• –°–∫–∞—á–∞—Ç—å backup-config.json';
        a.style.display = 'inline-block';
        a.style.marginTop = '10px';
        a.style.textDecoration = 'none';
        a.style.padding = '6px 10px';
        a.style.background = '#4CAF50';
        a.style.color = 'white';
        a.style.borderRadius = '4px';
        output.appendChild(document.createElement('br'));
        output.appendChild(a);
    }
</script>
</body>
</html>